# 订单管理系统后端方案设计

## 项目概述

基于微信小程序云托管服务（Node.js Express）的订单管理系统后端设计方案。系统主要功能包括商品 management、客户管理、订单处理、客户专属定价以及数据统计分析。

## 技术栈

- **云托管**: 微信云托管容器服务
- **运行环境**: Node.js 18+
- **Web框架**: Express.js
- **数据库**: MySQL (兼容云托管)
- **ORM**: Sequelize.js
- **身份认证**: 微信小程序认证
- **API文档**: OpenAPI 3.0

## 数据库设计

### 1. 商品表 (products)

```sql
CREATE TABLE products (
  id VARCHAR(36) PRIMARY KEY DEFAULT '',
  name VARCHAR(100) NOT NULL COMMENT '商品名称',
  global_price DECIMAL(10,2) NOT NULL DEFAULT 0.00 COMMENT '默认售价',
  unit VARCHAR(20) NOT NULL DEFAULT '个' COMMENT '计价单位',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_name (name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商品表';
```

### 2. 客户表 (customers)

```sql
CREATE TABLE customers (
  id VARCHAR(36) PRIMARY KEY DEFAULT '',
  name VARCHAR(50) NOT NULL COMMENT '客户姓名',
  phone VARCHAR(20) COMMENT '联系电话',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_name (name),
  INDEX idx_phone (phone)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='客户表';
```

### 3. 订单表 (orders)

```sql
CREATE TABLE orders (
  id VARCHAR(36) PRIMARY KEY DEFAULT '',
  order_no VARCHAR(20) UNIQUE NOT NULL COMMENT '订单号',
  customer_id VARCHAR(36) NOT NULL COMMENT '客户ID',
  total_amount DECIMAL(10,2) DEFAULT 0.00 COMMENT '订单总金额',
  status VARCHAR(50) DEFAULT 'draft' COMMENT '订单状态',
  remark TEXT COMMENT '备注信息',
  created_by VARCHAR(50) COMMENT '创建人',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_order_no (order_no),
  INDEX idx_customer_id (customer_id),
  INDEX idx_status (status),
  INDEX idx_created_at (created_at),
  INDEX idx_created_by (created_by),
  FOREIGN KEY (customer_id) REFERENCES customers(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单表';
```

### 4. 订单项表 (order_items)

```sql
CREATE TABLE order_items (
  id VARCHAR(36) PRIMARY KEY DEFAULT '',
  order_id VARCHAR(36) NOT NULL COMMENT '订单ID',
  product_id VARCHAR(36) NOT NULL COMMENT '商品ID',
  product_name VARCHAR(100) NOT NULL COMMENT '商品名称（冗余存储）',
  unit VARCHAR(20) NOT NULL COMMENT '计价单位（冗余存储）',
  quantity DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT '数量',
  unit_price DECIMAL(10,2) NOT NULL DEFAULT 0.00 COMMENT '单价',
  total_price DECIMAL(10,2) NOT NULL DEFAULT 0.00 COMMENT '小计',
  remark TEXT COMMENT '备注',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_order_id (order_id),
  INDEX idx_product_id (product_id),
  FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE,
  FOREIGN KEY (product_id) REFERENCES products(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单项表';
```

**设计说明**：
- `product_name` 和 `unit` 作为冗余字段存储
- 在创建订单时同步当前商品信息
- 订单创建后，即使商品信息变更，订单项数据保持不变
- 这样可以提升查询性能，避免复杂JOIN操作

### 5. 客户专属价格表 (customer_prices)

```sql
CREATE TABLE customer_prices (
  id VARCHAR(36) PRIMARY KEY DEFAULT '',
  customer_id VARCHAR(36) NOT NULL COMMENT '客户ID',
  product_id VARCHAR(36) NOT NULL COMMENT '商品ID',
  price DECIMAL(10,2) NOT NULL DEFAULT 0.00 COMMENT '专属价格',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_customer_product (customer_id, product_id),
  INDEX idx_customer_id (customer_id),
  INDEX idx_product_id (product_id),
  FOREIGN KEY (customer_id) REFERENCES customers(id) ON DELETE CASCADE,
  FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='客户专属价格表';
```

### 6. 订单状态流程表 (order_status_flows)

```sql
CREATE TABLE order_status_flows (
  id VARCHAR(36) PRIMARY KEY DEFAULT '',
  order_id VARCHAR(36) NOT NULL COMMENT '订单ID',
  from_status VARCHAR(50) COMMENT '原状态',
  to_status VARCHAR(50) NOT NULL COMMENT '目标状态',
  operator VARCHAR(50) NOT NULL COMMENT '操作人',
  remark TEXT COMMENT '操作备注',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_order_id (order_id),
  INDEX idx_to_status (to_status),
  INDEX idx_created_at (created_at),
  FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单状态流程表';
```

### 7. 订单历史记录表 (order_histories)

```sql
CREATE TABLE order_histories (
  id VARCHAR(36) PRIMARY KEY DEFAULT '',
  order_id VARCHAR(36) NOT NULL COMMENT '订单ID',
  action VARCHAR(50) NOT NULL COMMENT '操作类型',
  description VARCHAR(200) COMMENT '操作描述',
  operator VARCHAR(50) COMMENT '操作人',
  changes JSON COMMENT '变更详情',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_order_id (order_id),
  INDEX idx_action (action),
  INDEX idx_created_at (created_at),
  FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单历史记录表';
```

### 8. 系统配置表 (system_configs)

```sql
CREATE TABLE system_configs (
  id VARCHAR(36) PRIMARY KEY DEFAULT '',
  config_key VARCHAR(50) UNIQUE NOT NULL COMMENT '配置键',
  config_value TEXT COMMENT '配置值',
  description VARCHAR(200) COMMENT '配置描述',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_config_key (config_key)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='系统配置表';
```

## API接口设计

### 基础响应格式

```json
{
  "code": 200,
  "message": "success",
  "data": {},
  "timestamp": "2024-01-15T10:30:00.000Z"
}
```

### 分页响应格式

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [],
    "total": 100,
    "page": 1,
    "pageSize": 20,
    "totalPages": 5
  },
  "timestamp": "2024-01-15T10:30:00.000Z"
}
```

### 商品管理 API

#### 1. 创建商品
- **URL**: `POST /api/products`
- **描述**: 创建新商品
- **请求体**:
```json
{
  "name": "苹果",
  "globalPrice": 5.50,
  "unit": "个"
}
```
- **响应体**: 商品信息

#### 2. 获取商品列表
- **URL**: `GET /api/products`
- **描述**: 获取商品分页列表
- **查询参数**:
  - `page`: 页码 (默认: 1)
  - `pageSize`: 每页数量 (默认: 20)
  - `keyword`: 搜索关键词
- **响应体**: 分页商品列表

#### 3. 获取商品详情
- **URL**: `GET /api/products/{id}`
- **描述**: 获取指定商品信息
- **响应体**: 商品详情

#### 4. 更新商品
- **URL**: `PUT /api/products/{id}`
- **描述**: 更新商品信息
- **请求体**:
```json
{
  "name": "苹果",
  "globalPrice": 5.80,
  "unit": "个"
}
```
- **响应体**: 更新后商品信息

#### 5. 删除商品
- **URL**: `DELETE /api/products/{id}`
- **描述**: 删除指定商品
- **响应体**: 操作结果

### 客户管理 API

#### 1. 创建客户
- **URL**: `POST /api/customers`
- **描述**: 创建新客户
- **请求体**:
```json
{
  "name": "张三",
  "phone": "13800138001"
}
```
- **响应体**: 客户信息

#### 2. 获取客户列表
- **URL**: `GET /api/customers`
- **描述**: 获取客户分页列表
- **查询参数**:
  - `page`: 页码
  - `pageSize`: 每页数量
  - `keyword`: 搜索关键词
- **响应体**: 分页客户列表

#### 3. 获取客户详情
- **URL**: `GET /api/customers/{id}`
- **描述**: 获取指定客户信息
- **响应体**: 客户详情

#### 4. 更新客户
- **URL**: `PUT /api/customers/{id}`
- **描述**: 更新客户信息
- **请求体**:
```json
{
  "name": "张三",
  "phone": "13800138002"
}
```
- **响应体**: 更新后客户信息

#### 5. 删除客户
- **URL**: `DELETE /api/customers/{id}`
- **描述**: 删除指定客户
- **响应体**: 操作结果

#### 6. 获取客户专属价格
- **URL**: `GET /api/customers/{customerId}/prices`
- **描述**: 获取客户专属价格列表
- **查询参数**:
  - `productId`: 商品ID (可选，筛选特定商品)
- **响应体**: 客户专属价格列表

#### 7. 设置客户专属价格
- **URL**: `POST /api/customers/{customerId}/prices`
- **描述**: 设置客户专属价格
- **请求体**:
```json
{
  "productId": "product-uuid-here",
  "price": 5.20
}
```
- **响应体**: 客户专属价格信息

### 订单管理 API

#### 1. 创建订单
- **URL**: `POST /api/orders`
- **描述**: 创建新订单
- **请求体**:
```json
{
  "customerId": "customer-uuid-here",
  "items": [
    {
      "productId": "product-uuid-here",
      "quantity": 5,
      "unit": "个",
      "unitPrice": 5.50
    }
  ],
  "remark": "备注信息"
}
```
- **响应体**: 订单信息

#### 2. 获取订单列表
- **URL**: `GET /api/orders`
- **描述**: 获取订单分页列表
- **查询参数**:
  - `page`: 页码
  - `pageSize`: 每页数量
  - `status`: 订单状态
  - `customerId`: 客户ID
  - `startDate`: 开始日期
  - `endDate`: 结束日期
  - `keyword`: 搜索关键词（订单号、客户名称）
- **响应体**: 分页订单列表

#### 3. 获取订单详情
- **URL**: `GET /api/orders/{id}`
- **描述**: 获取指定订单信息
- **查询参数**:
  - `includeHistory`: 是否包含历史记录 (boolean)
- **响应体**: 订单详情

#### 4. 更新订单状态
- **URL**: `PUT /api/orders/{id}/status`
- **描述**: 更新订单状态并记录状态流转
- **请求体**:
```json
{
  "status": "confirmed",
  "operator": "admin",
  "remark": "订单已确认"
}
```
- **响应体**: 操作结果

#### 5. 获取订单状态流转记录
- **URL**: `GET /api/orders/{id}/status-flows`
- **描述**: 获取订单状态流转历史
- **响应体**: 状态流转列表

### 统计分析 API

#### 1. 销售概览
- **URL**: `GET /api/analytics/overview`
- **描述**: 获取销售概览数据
- **查询参数**:
  - `startDate`: 开始日期
  - `endDate`: 结束日期
- **响应体**:
```json
{
  "totalOrders": 100,
  "totalAmount": 50000.00,
  "totalCustomers": 50,
  "averageOrderAmount": 500.00
}
```

#### 2. 销售趋势
- **URL**: `GET /api/analytics/trend`
- **描述**: 获取销售趋势数据
- **查询参数**:
  - `period`: 时间周期 (daily/weekly/monthly)
  - `startDate`: 开始日期
  - `endDate`: 结束日期
- **响应体**: 趋势数据列表

#### 3. 热销商品排行
- **URL**: `GET /api/analytics/top-products`
- **描述**: 获取热销商品排行
- **查询参数**:
  - `startDate`: 开始日期
  - `endDate`: 结束日期
  - `limit`: 排名数量 (默认: 10)
- **响应体**: 热销商品列表

#### 4. 客户分析
- **URL**: `GET /api/analytics/customers`
- **描述**: 获取客户分析数据
- **查询参数**:
  - `startDate`: 开始日期
  - `endDate`: 结束日期
- **响应体**: 客户分析数据

## 安全设计

### 1. 身份认证
- 使用微信小程序认证机制
- JWT Token验证
- 请求头添加 `Authorization: Bearer {token}`

### 2. 数据验证
- 使用 Joi 进行请求数据验证
- 防止SQL注入攻击
- 输入数据过滤和转义

### 3. 权限控制
- 基于角色的访问控制 (RBAC)
- API接口权限验证
- 操作日志记录

### 4. 数据安全
- 敏感信息加密存储
- 定期数据备份
- HTTPS通信加密

## 性能优化

### 1. 数据库优化
- 合理创建索引
- 查询语句优化
- 分页查询缓存

### 2. API性能
- Redis缓存热点数据
- 接口响应压缩
- 连接池管理

### 3. 并发控制
- 数据库连接池
- Redis分布式锁
- 乐观锁更新

## 部署方案

### 1. 微信云托管配置
- 使用云托管容器服务
- 配置环境变量
- 设置健康检查

### 2. 数据库部署
- 使用云托管MySQL服务
- 配置读写分离
- 定期备份策略

### 3. 监控告警
- 系统性能监控
- 错误日志收集
- 业务指标监控

## 开发建议

### 1. 项目结构
```
src/
├── controllers/     # 控制器
├── services/        # 业务逻辑
├── models/         # 数据模型
├── routes/         # 路由定义
├── middlewares/    # 中间件
├── utils/          # 工具函数
├── validators/     # 数据验证
└── config/         # 配置文件
```

### 2. 代码规范
- ESLint + Prettier
- TypeScript类型定义
- 统一的错误处理

### 3. 测试
- 单元测试覆盖率 > 80%
- 集成测试覆盖主要业务流程
- API自动化测试

---

**注意事项**:
1. 所有表格都使用UUID作为主键
2. 订单号格式：YYYYMMDD + 4位序号
3. 金额字段统一使用DECIMAL(10,2)类型
4. 所有时间字段统一使用UTC时间
5. API接口支持RESTful风格设计
6. 数据库支持软删除机制（可选）
